# 分布式事务
## 分布式事务的概念
- 比如下单业务,前端请求进入订单服务,创建订单写入数据库,然后订单服务调用购物车服务和库存服务:
  - 购物车服务负责清理购物车信息
  - 库存服务负责扣减商品库存
- 由于不同的微服务运行在不同的 tomcat 上,所以无法满足事务的 ACID 特性
- 分布式系统中,如果一个业务需要多个服务合作完成,而且每一个服务都有事务,多个事务必须同时成功或者失败,这样的事务就叫做分布式事务,其中的每一个事务就是一个分支事务,整个事务为全局事务
## 利用 Seata 解决分布式事务
- Seata 就是一套分布式解决事务的方式
- 解决分布式事务,各个子十五之间必须感知到彼此的事务状态,才可以保证状态的一致性
- Seata事务管理中有三个重要角色:
  - TC-事务协调者: 维护全局和分支事务的状态,协调全局事务提交或者回滚
  - TM-事务管理器: 定义全局事务的范围,开启全局事务,提交或者回滚全局事务
  - RM-资源管理器: 管理分支事务,与TC交谈从而注册分支事务和提交分支事务的状态
- Seata架构如下:
![Screenshot_20240730_150309_tv.danmaku.bilibilihd.jpg](imgs%2FScreenshot_20240730_150309_tv.danmaku.bilibilihd.jpg)
## 部署 TC 服务
- TC服务需要一个数据库,从而管理事务
- 一般不是 TC 服务和不是 nacos 服务的方式如出一辙,可以使用 docker 容器部署
## 微服务集成 Seata
- 步骤:
  - 首先引入依赖
  - 在application.yml中添加配置,配置文件中需要配置的信息如下,学习一样新的技术一定需要多阅读官方文档
![Screenshot_20240730_154126_tv.danmaku.bilibilihd.jpg](imgs%2FScreenshot_20240730_154126_tv.danmaku.bilibilihd.jpg)
- 但是注意 seata1.5.2和jdk17不兼容,需要使用 jdk11以一下版本
## XA 模式
- XA规范时一种分布式事务处理标准,XA规范描述了全局的TM和局部的RM之间的接口,几乎所欲的主流的关系型数据库都提供了XA标准支持,Seata的XA模式如下
![Screenshot_20240730_160506_tv.danmaku.bilibilihd.jpg](imgs%2FScreenshot_20240730_160506_tv.danmaku.bilibilihd.jpg)
- 一阶段的工作:
  - RM注册分支事务到 TC
  - RM执行分支业务sql但是不提交
  - RM报告执行状态到TC
- 二阶段的工作:
  - TC检测各个分支事务提交状态
    - 如果都成功,同时所有的RM提交事务
    - 如果有失败的,通知所有的RM回滚事务
  - RM接受TC指令,提交或者回滚事务
- XA模式的优点:
  - 事务的强一致性,满足ACID特性
  - 常用的数据库都支持,满足简单,并且没有代码侵入
- XA模式的缺点:
  - 因为一阶段需要锁定数据库资源,需要等待二阶段结束才可以释放,性能比较差
  - 依赖关系型数据库实现事务
- 实现XA模式:
  - 修改 application.yml文件,开启 XA 模式
  - 给发起全局事务的入口添加@GlobalTransactional注解
- 可以在 nacos 中修改配置文件
- 注意需要事务管理的方法还是需要使用 @Transaction 
## AT 模式
- Seata主推的就是AT模式,AT模式同样是分阶段提交的事务模型,不过弥补了XA模型中资源锁定周期较长的缺陷
- 为了解决XA模式中最后一起提交sql的问题,AT模式利用一个 undo.log来记录回滚之前的快照,当事务执行失败的时候,根据快照进行事务的回滚
- AT模式的架构图如下:
![Screenshot_20240730_163543_tv.danmaku.bilibilihd.jpg](imgs%2FScreenshot_20240730_163543_tv.danmaku.bilibilihd.jpg)
- AT模式和XA模式的区别:
  - XA模式一阶段不提交事务,锁定资源,AT模式一阶段直接提交,不会锁定资源
  - XA模式依赖数据库机制实现回滚,AT模式利用数据块找实现数据回滚
  - XA模式强一致性,AT模式最终一致
## AT模式实现方式
- 首先设置 undo_log表用于保存数据快照,每一个微服务对应的数据库表都需要有这样一张表
- 改变事务模式为 AT(默认)
- 其他的参考XA模式的设置